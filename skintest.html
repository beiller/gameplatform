<!DOCTYPE html>
<html lang="en">
	<head>
		<title>mygame</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
            @font-face {
                font-family: 'MainFont';
                src: url('/fonts/riky-vampdator-normal.riky-vampdator-normal.ttf');
            }
			body {
				background:#000;
				color:#aaa;
				padding:0;
				margin:0;
				font-weight: bold;
				overflow:hidden;
			}

            html body {
                -webkit-touch-callout:none;
                -webkit-user-select:none;
                -khtml-user-select:none;
                -moz-user-select:none;
                -ms-user-select:none;
                user-select:none;
                -webkit-tap-highlight-color:rgba(0,0,0,0);
            }

            div.button {
                height: 100px;
                width: 100px;
                border: solid 1px #000000;
                background-color: #ffffff;
                position: absolute;
                top: 0px;
                left: 0px;
            }
		</style>
	</head>

	<body oncontextmenu="return false;">
        <div id="debugConsole" style="position:absolute;top:0;left:0;width:200px;height:50px;background-color:white;color:black">Test</div>
		<script src="cannon.js"></script>
		<script src="three.js/build/three.js"></script>
		<script src="javascript-state-machine/state-machine.min.js"></script>
        <script src="gamecontroller.min.js"></script>

		<script src="shaders/ShaderSkinCustom.js"></script>

		<script src="three.js/examples/js/shaders/BleachBypassShader.js"></script>
		<script src="three.js/examples/js/shaders/ConvolutionShader.js"></script>
		<script src="three.js/examples/js/shaders/CopyShader.js"></script>

		<script src="three.js/examples/js/postprocessing/EffectComposer.js"></script>
		<script src="three.js/examples/js/postprocessing/RenderPass.js"></script>
		<script src="three.js/examples/js/postprocessing/BloomPass.js"></script>
		<script src="three.js/examples/js/postprocessing/TexturePass.js"></script>
		<script src="three.js/examples/js/postprocessing/ShaderPass.js"></script>
		<script src="three.js/examples/js/postprocessing/MaskPass.js"></script>
		<script src="SkinShaderPass.js"></script>
        <script src="Game.js"></script>
        <script src="Character.js"></script>
        <script src="Controller.js"></script>
		<script src="AIController.js"></script>
		<script src="UserController.js"></script>
		<script src="CharacterStats.js"></script>

		<script src="three.js/examples/js/controls/OrbitControls.js"></script>
		<script src="three.js/examples/js/Detector.js"></script>
<script>


function loadJSON(path, success, error) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function()
    {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                if (success)
                    success(JSON.parse(xhr.responseText));
            } else {
                if (error)
                    error(xhr);
            }
        }
    };
    xhr.open("GET", path, true);
    xhr.send();
}

function runGame(data) {
    var items = data;
    var game = new Game();
    game.initRendering();
    game.initPhysics();
    var objectCount = 0;
    var outfit1 = [
        {
            model: "models/neweve_hair.json",
            options: {reflectivity: 0.0001, color: "0xFFB7DD"}
        },
        {model: "models/neweve_eyes.json",options: {reflectivity: 0.15}},
        {model: "models/neweve_eyelash.json"},
        {model: "models/neweve_eyebrows.json"},
        {model: "models/neweve_mouth.json",options: {reflectivity: 0.05}},
        {model: "models/neweve_fingernails.json",options: {reflectivity: 0.25, color: "0xFFB7DD"}},
        {model: "models/armor_armbands.json",options: {reflectivity: 0.2, color: "0x777777"}},
        {model: "models/armor_legbands.json",options: {reflectivity: 0.2, color: "0x777777"}},
        {model: "models/thighhigh.json",options: {reflectivity: 0.000001, color: "0xFFB7DD"}},
        {model: "models/armor_boob.json",options: {reflectivity: 0.2, color: "0x777777"}},
        {model: "models/armor_thong.json",options: {reflectivity: 0.01, color: "0xFFB7DD"}},
        {model: "models/neweveunderwear.json",options: {reflectivity: 0.01, color: "0xFFB7DD"}}
    ];
    var outfit2 = [
        {
            model: "models/neweve_hair.json",
            options: {reflectivity: 0.0001, color: "0x110000"}
        },
        {model: "models/neweve_eyes.json",options: {reflectivity: 0.15}},
        {model: "models/neweve_eyelash.json"},
        {model: "models/neweve_eyebrows.json"},
        {model: "models/neweve_mouth.json",options: {reflectivity: 0.05}},
        {model: "models/neweve_fingernails.json",options: {reflectivity: 0.25, color: "0x660000"}},
        {model: "models/armor_armbands.json",options: {reflectivity: 0.2, color: "0x222222"}},
        {model: "models/armor_legbands.json",options: {reflectivity: 0.2, color: "0x222222"}},
        {model: "models/thighhigh.json",options: {reflectivity: 0.000001, color: "0xeeeeee"}},
        {model: "models/armor_boob.json",options: {reflectivity: 0.2, color: "0x222222"}},
        {model: "models/armor_thong.json",options: {reflectivity: 0.01, color: "0x222222"}},
        {model: "models/neweveunderwear.json",options: {reflectivity: 0.01, color: "0x222222"}}
    ];
    var bricks = [];
    for(var i = -10; i<10; i++) {
        var randomHeight = (Math.random() - 0.5) * 0.5;
        bricks.push({model: 'models/big_brick.json', shape: 'box', position: [2*i,-3+randomHeight,0]});
    }

    var level = {
        staticObjects: bricks,
        characters: {
            evil_eve: {
                model: "models/neweve.json",
                sss: true,
                diffusePath: "models/textures/young_darkskinned_female_diffuse.png",
                specularPath: "models/textures/specular.png",
                normalPath: "models/textures/newevenormal.png",
                //clothing: outfit2,
                equipment:  [ items.firesword, items.evilchestarmor, items.holyarms, items.holylegs, items.holythong ]
            },
            good_eve: {
                model: "models/neweve.json",
                sss: true,
                diffusePath: "models/textures/young_lightskinned_female_diffuse3.png",
                specularPath: "models/textures/specular.png",
                normalPath: "models/textures/newevenormal.png",
                //clothing: outfit1,
                equipment: [ items.icesword, items.holychestarmor, items.holyarms, items.holylegs, items.holythong ]
            }
        },
        npcs : [
            {character: 'evil_eve', position: [-20,0,0]},
            {character: 'evil_eve', position: [20,0,0]},
            {character: 'evil_eve', position: [-11,0,0]},
            {character: 'evil_eve', position: [11,0,0]}
        ],
        player: {
            character: 'good_eve', position: [0,0,0]
        }
    };

    function loadLevel(level) {
        var id_counter = 0;
        //load player
        var player = level.characters[level.player.character];
        game.loadCharacter(
                player.model,
                {
                    name: 'eve',
                    sss: player.sss,
                    diffusePath: player.diffusePath,
                    specularPath: player.specularPath,
                    normalPath: player.normalPath,
                    position: level.player.position
                }, function(characterObject) {
                    characterObject.addController(new UserController(characterObject, game));
                    player.equipment.forEach(function(item) {
                    	characterObject.equip(item);
                    });
                }
        );

        level.staticObjects.forEach(function(element) {
            game.loadStaticObject(element.model, element.shape, element.position);
        });

        level.npcs.forEach(function(npc) {
            var player = level.characters[npc.character];
            if(player === null) {
                console.log('no character by name: ', npc);
                return;
            }
            game.loadCharacter(
                    player.model,
                    {
                        name: 'monster'+id_counter,
                        sss: player.sss,
                        diffusePath: player.diffusePath,
                        specularPath: player.specularPath,
                        normalPath: player.normalPath,
                        position: npc.position
                    }, function(characterObject) {
                    	characterObject.addController(new AIController(characterObject, game));
	                    player.equipment.forEach(function(item) {
	                    	characterObject.equip(item);
	                    });
                    }
            );
            id_counter+=1;
        });

    }

    game.addGroundPlane(-4);
    game.loadEnvironment("textures/tropical_beach.jpg", function(mesh) {
    	loadLevel(level);
    });
    
    /*setInterval(function() {
        game.updateCubeMap();
    }, 1000);*/


    var fps = 60;
    var interval = 1000/fps;
    var drawTime = null;
    var logicTime = null;
    var frameTimer = new THREE.Clock(true);
    var frameCount = 0;
    var logicCount = 0;
    function draw() {
        requestAnimationFrame(draw);
        game.render();
    	if(frameTimer.getElapsedTime() >= 1.0) {
    		document.getElementById("debugConsole").innerHTML = "drawFPS: " + frameCount + "<br/>logicFPS: " + logicCount;
    		frameCount = 0;
    		logicCount = 0;
    		frameTimer = new THREE.Clock(true);
    	}
    	frameCount++;
    }
    var logicInterval = setInterval(function() {
    	game.animate();
    	logicCount++;
    }, 1000/30);

    draw();
}

loadJSON("items.json", runGame);
</script>

	</body>
</html>
