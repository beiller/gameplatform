<!DOCTYPE html>
<html lang="en">
	<head>
		<title>mygame</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
            @font-face {
                font-family: 'MainFont';
                src: url('/fonts/riky-vampdator-normal.riky-vampdator-normal.ttf');
            }
			body {
				background:#000;
				color:#aaa;
				padding:0;
				margin:0;
				font-weight: bold;
				overflow:hidden;
			}

            html body {
                -webkit-touch-callout:none;
                -webkit-user-select:none;
                -khtml-user-select:none;
                -moz-user-select:none;
                -ms-user-select:none;
                user-select:none;
                -webkit-tap-highlight-color:rgba(0,0,0,0);
            }

            div.button {
                height: 100px;
                width: 100px;
                border: solid 1px #000000;
                background-color: #ffffff;
                position: absolute;
                top: 0px;
                left: 0px;
            }
		</style>
	</head>

	<body oncontextmenu="return false;">
        <div id="debugConsole" style="position:absolute;top:0;left:0;width:200px;height:50px;background-color:white;color:black">Test</div>
		<script src="cannon.js"></script>
		<script src="three.mybuild.js"></script>
		<script src="state-machine.min.js"></script>

		<script src="shaders/ShaderSkinCustom.js"></script>

		<script src="three.js/examples/js/shaders/BleachBypassShader.js"></script>
		<script src="three.js/examples/js/shaders/ConvolutionShader.js"></script>
		<script src="three.js/examples/js/shaders/CopyShader.js"></script>

		<script src="three.js/examples/js/postprocessing/EffectComposer.js"></script>
		<script src="three.js/examples/js/postprocessing/RenderPass.js"></script>
		<script src="three.js/examples/js/postprocessing/BloomPass.js"></script>
		<script src="three.js/examples/js/postprocessing/TexturePass.js"></script>
		<script src="three.js/examples/js/postprocessing/ShaderPass.js"></script>
		<script src="three.js/examples/js/postprocessing/MaskPass.js"></script>
		<script src="SkinShaderPass.js"></script>
        <script src="Game.js"></script>
        <script src="PhysBone.js"></script>
        <script src="Character.js"></script>
        <script src="Controller.js"></script>
		<script src="AIController.js"></script>
		<script src="UserController.js"></script>
		<script src="CharacterStats.js"></script>

		<script src="three.js/examples/js/controls/OrbitControls.js"></script>
		<script src="three.js/examples/js/Detector.js"></script>
		
		<script src="zepto.js"></script>
		<style>
			.window {
				position: absolute;
			    border-radius: 5px;
			    border: 2px solid #73AD21;
			    padding: 20px;
			    width: 200px;
			    height: 150px;
			    background-color: rgba(255, 255, 255, 0.5);
			    z-index: 100;
			}
			.topright {
				top: 0px;
				right: 0px;
				z-index: 100;
			}
			.paneright {
				right: 200px;
				top: 0px;
				height: 100%;
				z-index: 101;
			}
			.paneleft {
				left: 0px;
				top: 0px;
				height: 100%;
				z-index: 101;
			}
			.window-inventory {
				visibility: hidden;
			}
			.button {
			    border-radius: 5px;
			    border: 2px solid #73AD21;
			    display: block;
			    height: 30px;
			    line-height: 30px;
			    padding-left: 10px;
			    background-color: rgba(255, 255, 255, 1.0);
			    color: #000000;
			    text-decoration: none;
			}
		</style>
		<div class="window topright">
			<a href="#" class="button btn-openinventory">Toggle Inventory</a>
		</div>
		<div class="window paneright window-inventory inventory-menu">
			
		</div>
		<div class="window paneleft window-inventory loot-menu">
			
		</div>
<script>

function loadJSON(path, success, error) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function()
    {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                if (success)
                    success(JSON.parse(xhr.responseText));
            } else {
                if (error)
                    error(xhr);
            }
        }
    };
    path += '?cache=' + new Date().getTime();
    xhr.open("GET", path, true);
    xhr.send();
}

var GAME = (function () {
	var my = {},
		privateVariable = 1;

	function init() {
		// ...
	}

	my.moduleProperty = 1;
	my.moduleMethod = function () {
		// ...
	};

	return my;
}());



function HUD(game) {
	this.game = game;
	this.init();
}
HUD.prototype = {
	loadInventory: function() {
		var character = game.characters['eve'];
		var invWindow = $(".inventory-menu");
		var scope = this;
		invWindow.html("");
		character.inventory.forEach(function(inventoryItem) {
			var button = $("<a href='#' class='button'></a>");
			button.html(inventoryItem.name).on('click', function(e) {
				console.log("Equipping item " + inventoryItem.name);
				e.stopPropagation();
				character.removeItem(inventoryItem);
				character.equip(inventoryItem);
				scope.loadInventory();
			});
			invWindow.append(button);
		});
	},
	
	showLootMenu: function(container) {
		var invWindow = $(".loot-menu");
		var scope = this;
		invWindow.html("<h1>LOOT!</h1>");
		container.inventory.forEach(function(inventoryItem) {
			var button = $("<a href='#' class='button'></a>");
			button.html(inventoryItem.name).on('click', function(e) {
				console.log("Looted item " + inventoryItem.name);
				e.stopPropagation();
				container.removeItem(inventoryItem);
				scope.game.characters['eve'].addItem(inventoryItem);
				scope.showLootMenu(container);
			});
			invWindow.append(button);
		});
		if(container.equipment !== undefined) {
			for(var slot in container.equipment) {
				(function(inventoryItem){
					var button = $("<a href='#' class='button'></a>");
					button.html(inventoryItem.name).on('click', function(e) {
						console.log("Looted item " + inventoryItem.name);
						e.stopPropagation();
						container.unequip(inventoryItem.slot);
						container.removeItem(inventoryItem);
						scope.game.characters['eve'].addItem(inventoryItem);
						scope.showLootMenu(container);
					});
					invWindow.append(button);
				})(container.equipment[slot]);
			}
		}
		this.loadInventory();
	},
	
	init: function() {
		var scope = this;
		$(".btn-openinventory").on('click', function(e) {
			e.stopPropagation();
			var invWindow = $(".inventory-menu");
			if(invWindow.css('visibility') == 'hidden') {
				invWindow.css('visibility', 'visible');
			} else {
				invWindow.css('visibility', 'hidden');
			}
			scope.loadInventory();
			return false;
		});
		$(window).on('mousemove', function(e) {
			var me = game.characters['eve'];
			var found = null;
			var best_dist = 100.0;
			for(var char_id in game.characters) {
				(function(character) {
					if(character != me) {
						var dist = character.getDistance(me);
						if(dist < 1.0 && dist < best_dist) {
							best_dist = dist;
							found = character;
						}
					}
				})(game.characters[char_id]);
			}
			if(found === null) {
				$(".loot-menu").css('visibility', 'hidden');
			} else {
				$(".loot-menu").css('visibility', 'visible');
				scope.showLootMenu(found);
			}
			return false;
		});
	}
};




var gameSettings = null;
var game = null;

function runGame(data) {
    var items = data;
    game = new Game(gameSettings);
    game.initRendering();
    game.initPhysics();
    var objectCount = 0;
    
    var hud = new HUD(game);

    var bricks = [];
    for(var i = -50; i<=50; i++) {
        var randomHeight = (Math.random() - 0.5) * 0.5;
        bricks.push({model: 'models/big_brick.json', shape: 'box', position: [2*i,-3+randomHeight,0]});
    }

    var level = {
        staticObjects: bricks,
        characters: {
            evil_eve: {
                model: "models/neweve_highres.json",
                sss: true,
                diffusePath: "models/textures/young_darkskinned_female_diffuse.png",
                specularPath: "models/textures/specular.png",
                normalPath: "models/textures/newevenormal.png",
                equipment:  [ 
                	items.rustsword, 
                	items.evilunderwear, 
                	items.evilsocks,
                	items.face,
                	items.hairevil,
                	items.evilnails
                	
                ]
            },
            skeleton: {
                model: "models/skeleton.json",
                sss: false,
                diffusePath: "models/textures/young_darkskinned_female_diffuse.png",
                specularPath: "models/textures/specular.png",
                normalPath: "models/textures/normal_none.png",
                equipment:  [ 
                	items.rustsword
                ]
            },            
            good_eve: {
                model: "models/neweve_highres.json",
                sss: true,
                diffusePath: "models/textures/young_lightskinned_female_diffuse3.png",
                specularPath: "models/textures/specular.png",
                normalPath: "models/textures/newevenormal.png",
                equipment: [ 
                	items.holyunderwear, 
                	items.face,
                	items.hairprincess,
                	items.holynails
                ],
                inventory: [
                	items.rustsword, 
                	items.holychestarmor,
                	items.holysocks,
                	items.firesword, 
                	items.rustsword,
                	items.evilchestarmor,
                	items.holylegs
                ]
            }
        },
        npcs : [
            {character: 'evil_eve', position: [-20,0,0]},
            {character: 'evil_eve', position: [20,0,0]}
            //{character: 'evil_eve', position: [-11,0,0]},
            //{character: 'evil_eve', position: [11,0,0]}
        ],
        player: {
            character: 'good_eve', position: [0,0,0]
        }
    };
    var id_counter = 0;
	function spawn_npc(name, player, position, controllerConstructor) {
            if(!player) {
                console.log('no player specified');
                return;
            }
            controllerConstructor = controllerConstructor ? controllerConstructor : AIController;
            
            game.loadCharacter(
                    player.model,
                    {
                        name: name,
                        sss: player.sss,
                        diffusePath: player.diffusePath,
                        specularPath: player.specularPath,
                        normalPath: player.normalPath,
                        position: position
                    }, function(characterObject) {
                    	characterObject.addController(new controllerConstructor(characterObject, game));
	                    player.equipment.forEach(function(item) {
	                    	characterObject.equip(item);
	                    });
	                    if(player.inventory != undefined) {
		                    player.inventory.forEach(function(item) {
		                    	characterObject.inventory.push(item);
		                    });
	                    }
                    }
            );
            
	}
    function loadLevel(level) {
        //load player
        var player = level.characters[level.player.character];
        game.loadCharacter(
                player.model,
                {
                    name: 'eve',
                    sss: player.sss,
                    diffusePath: player.diffusePath,
                    specularPath: player.specularPath,
                    normalPath: player.normalPath,
                    position: level.player.position
                }, function(characterObject) {
                    characterObject.addController(new UserController(characterObject, game));
                    player.equipment.forEach(function(item) {
                    	characterObject.equip(item);
                    });
                    player.inventory.forEach(function(item) {
                    	characterObject.inventory.push(item);
                    });
                }
        );

        level.staticObjects.forEach(function(element) {
            game.loadStaticObject(element.model, element.shape, element.position);
        });

        level.npcs.forEach(function(npc) {
            spawn_npc('monster'+id_counter, level.characters[npc.character], npc.position);
            id_counter+=1;
        });
        
        setInterval(function() {
    		spawn_npc('monster'+id_counter, level.characters.skeleton, [Math.random() * 200 - 100,0,0]);
    		id_counter+=1;
    	}, 12000);

    }

    game.addGroundPlane(-4);
    game.loadEnvironment("textures/tropical_beach.jpg", function(mesh) {
    	game.updateCubeMap();
    	loadLevel(level);
    });
    
    /*setInterval(function() {
        game.updateCubeMap();
    }, 1000);*/


    var fps = 60;
    var interval = 1000/fps;
    var drawTime = null;
    var logicTime = null;
    var frameTimer = new THREE.Clock(true);
    var frameCount = 0;
    var logicCount = 0;
    function draw() {
        requestAnimationFrame(draw);
        game.render();
    	if(frameTimer.getElapsedTime() >= 1.0) {
    		document.getElementById("debugConsole").innerHTML = "drawFPS: " + frameCount + "<br/>logicFPS: " + logicCount;
    		frameCount = 0;
    		logicCount = 0;
    		frameTimer = new THREE.Clock(true);
    	}
    	frameCount++;
    }
    var logicInterval = setInterval(function() {
    	game.animate();
    	logicCount++;
    }, interval);

    draw();
}
function doSettings(jsonData) {
	gameSettings = jsonData;
	loadJSON("items.json", runGame);
}
loadJSON("settings.json", doSettings);


</script>


	</body>
</html>
